<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>AR Test</title>

    <!-- Babylon.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

    <style>
      html,
      body {
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
      }

      #renderCanvas {
        width: 100vw;
        height: 100vh;
        touch-action: none;
      }
      #cover {
        width: 100vw;
        height: 100vh;
        background-color: red;
        position: absolute;
        z-index: 5;
      }
    </style>
  </head>
  <body>
    <div id="cover"></div>
    <canvas id="renderCanvas"></canvas>
    <script>
      var canvas = document.getElementById("renderCanvas");

      var startRenderLoop = function (engine, canvas) {
        engine.runRenderLoop(function () {
          if (sceneToRender && sceneToRender.activeCamera) {
            sceneToRender.render();
          }
        });
      };

      var engine = null;
      var scene = null;
      var sceneToRender = null;
      var createDefaultEngine = function () {
        return new BABYLON.Engine(canvas, true, {
          preserveDrawingBuffer: true,
          stencil: true,
          disableWebGL2Support: false,
        });
      };
      var createScene = async function () {
        var scene = new BABYLON.Scene(engine);
        var camera = new BABYLON.FreeCamera(
          "camera1",
          new BABYLON.Vector3(0, 5, -10),
          scene
        );
        camera.setTarget(BABYLON.Vector3.Zero());
        camera.attachControl(canvas, true);
        // var light = new BABYLON.HemisphericLight(
        //   "light1",
        //   new BABYLON.Vector3(0, 1, 0),
        //   scene
        // );
        // light.intensity = 0.7;

        scene.environmentTexture = new BABYLON.CubeTexture(
          "https://raw.githubusercontent.com/veljko85/environments/gh-pages/environment.env",
          scene
        );

        BABYLON.SceneLoader.ImportMeshAsync(
          "",
          "https://raw.githubusercontent.com/veljko85/GucciSylvieBag/gh-pages/meshes/",
          "torba7.glb"
        ).then((result) => {
          var torba = result.meshes[0];
          //   torba.rotationQuaternion = null;
          torba.scaling = new BABYLON.Vector3(3, 3, 3);
          torba.position = new BABYLON.Vector3(0, 0, 3);

          scene.animationGroups
            .find((a) => a.name === "teloAction.001")
            .stop(true, 1, 0);

          var teloMaterials = [
            "braon_koza",
            "plavi_tekstil",
            "sare_tekstil",
            "telo",
          ];

          for (let i = 0; i < teloMaterials.length; i++) {
            scene.getMaterialByID(teloMaterials[i]).ambientTexture =
              new BABYLON.Texture(
                "https://raw.githubusercontent.com/veljko85/GucciSylvieBag/gh-pages/textures/telo.png",
                scene
              );
            scene.getMaterialByID(teloMaterials[i]).ambientTexture.uScale = 1; //and/or the following for vScale:
            scene.getMaterialByID(teloMaterials[i]).ambientTexture.vScale = -1; //(-1.0 or some other value)

            // scene.getMaterialByID(teloMaterials[i]).environmentIntensity = 0;
          }

          scene.getMaterialByID("masne").ambientTexture = new BABYLON.Texture(
            "https://raw.githubusercontent.com/veljko85/GucciSylvieBag/gh-pages/textures/masne.png",
            scene
          );
          scene.getMaterialByID("masne").ambientTexture.uScale = 1; //and/or the following for vScale:
          scene.getMaterialByID("masne").ambientTexture.vScale = -1; //(-1.0 or some other value)

          var gui =
            BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("myUI");
          var button = BABYLON.GUI.Button.CreateSimpleButton(
            "button",
            "Black Bag"
          );
          button.verticalAlignment =
            BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
          button.top = "0px";
          button.left = "0px";
          button.width = 0.2;
          button.height = 0.1;
          button.cornerRadius = 20;
          button.thickness = 4;
          button.children[0].color = "#DFF9FB";
          button.children[0].fontSize = 24;
          button.color = "#FF7979";
          button.background = "#EB4D4B";

          var clicks = 0;
          button.onPointerClickObservable.add(function () {
            setTimeout(function () {
              scene.getMeshByName("telo_primitive0").material =
                scene.getMaterialByID("braon_koza");
              scene.getMeshByName("telo_primitive4").material =
                scene.getMaterialByID("braon_koza_rucka");
              scene.getMaterialByID("braon_koza").albedoColor =
                BABYLON.Color3.FromHexString("#000000");
              scene.getMaterialByID("sav").albedoColor =
                BABYLON.Color3.FromHexString("#000000");
            }, 500);
            scene.animationGroups
              .find((a) => a.name === "teloAction.001")
              .start(false, 1, 0);
          });
          gui.addControl(button);
        });

        const xr = await scene.createDefaultXRExperienceAsync({
          uiOptions: {
            sessionMode: "immersive-ar",
          },
        });

        var arBut = document.getElementsByClassName("xr-button-overlay");
        console.log(arBut);

        return scene;
      };
      window.initFunction = async function () {
        var asyncEngineCreation = async function () {
          try {
            return createDefaultEngine();
          } catch (e) {
            console.log(
              "the available createEngine function failed. Creating the default engine instead"
            );
            return createDefaultEngine();
          }
        };

        window.engine = await asyncEngineCreation();
        if (!engine) throw "engine should not be null.";
        startRenderLoop(engine, canvas);
        window.scene = createScene();
      };
      initFunction().then(() => {
        scene.then((returnedScene) => {
          sceneToRender = returnedScene;
        });
      });

      // Resize
      window.addEventListener("resize", function () {
        engine.resize();
      });
    </script>
  </body>
</html>
